<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PiHole-NetShield GUI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="p-3">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <h1>PiHole-NetShield</h1>
        <div>
          <span class="badge bg-secondary">Local admin</span>
        </div>
      </div>

      <hr>

      <div class="row">
        <div class="col-md-6">
          <h3>Service Controls</h3>
          <div class="mb-2">
            <button id="startBtn" class="btn btn-success">Start</button>
            <button id="stopBtn" class="btn btn-danger">Stop</button>
            <button id="restartBtn" class="btn btn-warning">Restart</button>
          </div>
          <div class="mb-2">
            <button id="checkStatusBtn" class="btn btn-outline-primary">Check status</button>
            <button id="updateBtn" class="btn btn-outline-success">System & Pi-hole Update</button>
            <button id="backupBtn" class="btn btn-outline-secondary">Backup Config</button>
          </div>
        </div>
        <div class="col-md-6">
          <h3>Blocklist</h3>
          <div class="mb-2">
            <form id="blocklistForm">
              <div class="mb-2">
                <input name="url" placeholder="Blocklist URL" class="form-control" required>
              </div>
              <div class="mb-2">
                <input name="name" placeholder="Short name" class="form-control" required>
              </div>
              <button class="btn btn-primary">Add</button>
              <button id="updateBlocklistsBtn" class="btn btn-outline-secondary">Update All</button>
            </form>
          </div>
        </div>

          <div class="row mt-3">
            <div class="col-md-6">
              <h3>Local DNS Records</h3>
              <form id="localDnsForm">
                <div class="mb-2">
                  <input name="ip" placeholder="IP (e.g., 192.168.1.2)" class="form-control" required>
                </div>
                <div class="mb-2">
                  <input name="hostname" placeholder="Hostname (e.g., nas.local)" class="form-control" required>
                </div>
                <button class="btn btn-primary">Add Record</button>
              </form>
              <div class="mt-2"><button id="listLocalDnsBtn" class="btn btn-sm btn-outline-secondary">List Local Records</button></div>
            </div>
            <div class="col-md-6">
              <h3>Backups & Teleporter</h3>
              <div class="mb-2">
                <button id="exportBackupBtn" class="btn btn-outline-primary">Create Backup Now</button>
                <button id="rsyncBackupBtn" class="btn btn-outline-info">Rsync Backup to Remote</button>
              </div>
            </div>
          </div>
      </div>

      <hr>

      <h3>Features</h3>
      <div id="featuresArea" class="mb-3"></div>
      <button id="saveFeaturesBtn" class="btn btn-sm btn-primary">Save Features</button>

      <hr>

      <h3>Logs</h3>
      <div>
        <button id="ftlLogsBtn" class="btn btn-sm btn-info">FTL Warnings (last 6 hours)</button>
        <button id="viewLogsBtn" class="btn btn-sm btn-secondary">Tail Pi-hole Logs (200)</button>
      </div>

      <pre id="output" class="mt-3 bg-dark text-white p-3" style="height:300px; overflow:auto;"></pre>
    </div>

    <script>
      async function request(endpoint, opts) {
        const token = '';
        const headers = opts && opts.headers ? opts.headers : {};
        if (token) headers['Authorization'] = 'Bearer ' + token;
        const r = await fetch(endpoint, {headers, ...opts});
        return r.json();
      }

      document.getElementById('startBtn').onclick = async () => {
        const r = await request('/api/start', { method: 'POST' });
        document.getElementById('output').textContent = JSON.stringify(r, null, 2);
      }

      document.getElementById('stopBtn').onclick = async () => {
        const r = await request('/api/stop', { method: 'POST' });
        document.getElementById('output').textContent = JSON.stringify(r, null, 2);
      }

      document.getElementById('restartBtn').onclick = async () => {
        const r = await request('/api/restart', { method: 'POST' });
        document.getElementById('output').textContent = JSON.stringify(r, null, 2);
      }

      document.getElementById('checkStatusBtn').onclick = async () => {
        const r = await request('/api/status');
        document.getElementById('output').textContent = JSON.stringify(r, null, 2);
      }

      document.getElementById('updateBtn').onclick = async () => {
        const r = await request('/api/update', { method: 'POST' });
        document.getElementById('output').textContent = JSON.stringify(r, null, 2);
      }

      document.getElementById('backupBtn').onclick = async () => {
        const r = await request('/api/backup', { method: 'POST' });
        document.getElementById('output').textContent = JSON.stringify(r, null, 2);
      }

      document.getElementById('blocklistForm').onsubmit = async (evt) => {
        evt.preventDefault();
        const fd = new FormData(evt.target);
        const url = fd.get('url');
        const name = fd.get('name');
        const r = await request('/api/add-blocklist', {method: 'POST', headers:{'Content-Type': 'application/json'}, body: JSON.stringify({url, name})});
        document.getElementById('output').textContent = JSON.stringify(r, null, 2);
      }

      document.getElementById('updateBlocklistsBtn').onclick = async (evt) => {
        evt.preventDefault();
        const r = await request('/api/update-blocklists', {method: 'POST'});
        document.getElementById('output').textContent = JSON.stringify(r, null, 2);
      }

      document.getElementById('viewLogsBtn').onclick = async () => {
        const r = await request('/api/logs');
        document.getElementById('output').textContent = r.output || JSON.stringify(r, null, 2);
      }

      document.getElementById('localDnsForm').onsubmit = async (evt) => {
        evt.preventDefault();
        const fd = new FormData(evt.target);
        const ip = fd.get('ip');
        const name = fd.get('hostname');
        const r = await request('/api/localdns', {method: 'POST', headers:{'Content-Type': 'application/json'}, body: JSON.stringify({ip, name})});
        document.getElementById('output').textContent = JSON.stringify(r, null, 2);
      }

      document.getElementById('listLocalDnsBtn').onclick = async () => {
        const r = await request('/api/localdns');
        document.getElementById('output').textContent = r.output || JSON.stringify(r, null, 2);
      }

      document.getElementById('exportBackupBtn').onclick = async () => {
        const r = await request('/api/backup', { method: 'POST' });
        document.getElementById('output').textContent = JSON.stringify(r, null, 2);
      }

      document.getElementById('rsyncBackupBtn').onclick = async () => {
        const r = await request('/api/rsync-backup', { method: 'POST' });
        document.getElementById('output').textContent = JSON.stringify(r, null, 2);
      }

      document.getElementById('ftlLogsBtn').onclick = async () => {
        const r = await request('/api/ftl-errors');
        document.getElementById('output').textContent = r.output || JSON.stringify(r, null, 2);
      }

      async function fetchFeatures() {
        const r = await request('/api/features');
        if (r.ok && r.features) {
          const container = document.getElementById('featuresArea');
          container.innerHTML = '';
          for (const [k, v] of Object.entries(r.features)) {
            const id = 'f_' + k;
            container.innerHTML += `<div class="form-check"><input class="form-check-input" type="checkbox" value="" id="${id}" ${v ? 'checked' : ''}><label class="form-check-label" for="${id}">${k}</label></div>`;
          }
        }
      }

      document.getElementById('saveFeaturesBtn').onclick = async () =&gt; {
        const container = document.getElementById('featuresArea');
        const inputs = container.querySelectorAll('input[type=checkbox]');
        const payload = {};
        inputs.forEach(i =&gt; { payload[i.id.substr(2)] = i.checked; });
        const r = await request('/api/features', {method:'POST', headers:{'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
        document.getElementById('output').textContent = JSON.stringify(r, null, 2);
      }

      fetchFeatures();
    </script>
  </body>
</html>