---
- name: Install GUI dependencies
  apt:
    name:
      - python3-pip
      - python3-venv
      - nginx
      - git
      - apache2-utils
    state: present
  become: true

- name: Create gui user
  user:
    name: pihole-gui
    comment: "PiHole NetShield GUI user"
    home: /opt/pihole-netshield-gui
    shell: /bin/bash
    system: true
  become: true

- name: Ensure GUI directory exists
  file:
    path: /opt/pihole-netshield-gui
    state: directory
    owner: pihole-gui
    group: pihole-gui
    mode: '0755'
  become: true

- name: Copy GUI files
  copy:
    src: gui/
    dest: /opt/pihole-netshield-gui/
    owner: pihole-gui
    group: pihole-gui
    mode: '0755'
  become: true

- name: Install Python requirements
  pip:
    requirements: /opt/pihole-netshield-gui/gui/requirements.txt
    virtualenv: /opt/pihole-netshield-gui/venv
    virtualenv_command: /usr/bin/python3 -m venv
    virtualenv_site_packages: false
  become: true

- name: Create systemd unit for GUI
  template:
    src: pi-gui.service.j2
    dest: /etc/systemd/system/pihole-netshield-gui.service
    mode: '0644'
  notify:
    - daemon-reload
  become: true

- name: Ensure GUI is enabled and started
  systemd:
    name: pihole-netshield-gui
    enabled: true
    state: started
  become: true

- name: Configure htpasswd for Nginx (optional)
  import_tasks: htpasswd.yml
  when: htpasswd_enabled

- name: Configure and mount remote NFS backup (optional)
  import_tasks: nfs.yml
  when: remote_backup_enabled

- name: Ensure scheduled weekly backup if remote backup enabled
  import_tasks: backup_schedule.yml
  when: remote_backup_enabled

- name: Create sudoers for pihole-gui to manage pihole services and scripts
  copy:
    dest: /etc/sudoers.d/pihole-gui
    content: |
      pihole-gui ALL=(ALL) NOPASSWD: \
        /bin/systemctl start pihole-FTL, \
        /bin/systemctl stop pihole-FTL, \
        /bin/systemctl restart pihole-FTL, \
        /usr/local/bin/backup_restore.sh, \
        /usr/local/bin/auto_update.sh, \
        /usr/local/bin/custom_blocklist_manager.sh, \
        /usr/local/bin/local_dns.sh
    owner: root
    group: root
    mode: '0440'
  become: true

- name: Create features config directory
  file:
    path: /etc/pihole-netshield
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Deploy default feature flags
  template:
    src: features.j2
    dest: /etc/pihole-netshield/features.json
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Install certbot for Let's Encrypt (optional)
  apt:
    name:
      - certbot
      - python3-certbot-nginx
    state: present
  become: true

- name: Create webroot for certbot
  file:
    path: /var/www/certbot
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Create nginx site for GUI
  template:
    src: "{{ 'nginx-pihole-auth.conf.j2' if htpasswd_enabled else 'nginx-pihole.conf.j2' }}"
    dest: /etc/nginx/sites-available/pihole-netshield
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload nginx
  become: true

- name: Enable nginx site
  file:
    src: /etc/nginx/sites-available/pihole-netshield
    dest: /etc/nginx/sites-enabled/pihole-netshield
    state: link
  notify:
    - reload nginx
  become: true

- name: Obtain or renew Let's Encrypt certificate (optional)
  become: true
  shell: |
    if [ "{{ letsencrypt_enabled | default(false) }}" = "true" ] && [ -n "{{ gui_domain | default('') }}" ]; then
      certbot --nginx --non-interactive --agree-tos -m {{ certbot_email | default('') }} -d {{ gui_domain }}
    fi
  args:
    warn: false

- name: Generate self-signed certificate (optional)
  when: not letsencrypt_enabled and ssl_self_signed
  shell: |
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout {{ ssl_key_path }} -out {{ ssl_cert_path }} -subj "/C=US/ST=State/L=City/O=PiHole-NetShield/CN={{ gui_domain | default('localhost') }}"
  args:
    creates: "{{ ssl_cert_path }}"
  become: true

- name: Run ansible-playbook for GUI setup
  command: ansible-playbook -i ansible/inventory.example.ini --ask-vault-pass playbook.yml
  become: true
